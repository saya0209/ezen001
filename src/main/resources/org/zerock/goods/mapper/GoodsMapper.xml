<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="org.zerock.goods.mapper.GoodsMapper">
  	<!-- 상품 리스트 -->
  	<select id="list" resultType="org.zerock.goods.vo.GoodsVO">
  		select
	  		goods_no, goods_name, price, discount,
	  		sale_price, image_name
  		from
  		(
	  		select
	  			rownum rnum, goods_no, goods_name, price, discount,
	  			sale_price, image_name
	  		from
		  	(
		  		select
		  			g.goods_no, g.goods_name, p.price, p.discount,
		  			p.sale_price, g.image_name
		  		from
		  			goods g, goods_price p
		  		where
		  		(
		  			<!-- 검색조건 -->
		  			<include refid="search" />
		  			<!-- 일반조건 -->
		  			<!-- 현재 판매되고 있는 상품 -->
		  			<![CDATA[
		  			sale_start_date <= sysDate and
		  			trunc(sysDate) <= sale_end_date
		  			]]>
		  		)
		  		and
		  		(
		  			<!-- 조인 조건 -->
		  			g.goods_no = p.goods_no
		  		)
		  	)
	  	)
	  	where rnum between #{pageObject.startRow} and #{pageObject.endRow}
  	</select>
  	
  	<!-- 페이지 처리를 위한 getTotalRow -->
  	<select id="getTotalRow" resultType="Long">
  		select count(*)
  		from goods g, goods_price p
  		where
  		(
  			<!-- 검색조건 -->
 			<include refid="search" />
		  	<!-- 일반조건 -->
		  	<![CDATA[
		  	sale_start_date <= sysDate and
		  	trunc(sysDate) <= sale_end_date
		  	]]>
		)
		and
		(
			<!-- 조인 조건 -->
			g.goods_no = p.goods_no
		)
  	</select>
  	
  	<!-- 검색 -->
  	<sql id="search">
  		<trim prefixOverrides="and" suffix="and">
  			<!-- 카테고리 대분류, 중분류, 소분류 -->
	  	 	<if test="goodsSearchVO.cate_code1 != null and goodsSearchVO.cate_code1 != 0">
	  			and g.cate_code1 = #{goodsSearchVO.cate_code1}
	  			<if test="goodsSearchVO.cate_code2 != null and goodsSearchVO.cate_code2 != 0">
	  				and g.cate_code2 = #{goodsSearchVO.cate_code2}
	  				<if test="goodsSearchVO.cate_code3 != null and goodsSearchVO.cate_code3 != 0">
	  					and g.cate_code3 = #{goodsSearchVO.cate_code3}
	  				</if>
	  			</if>
			</if>
			<!-- 제품명 -->
			<if test="goodsSearchVO.goods_name != null and goodsSearchVO.goods_name != ''">
				and g.goods_name like '%' || #{goodsSearchVO.goods_name} || '%'
			</if>
			<!-- 최소가격 -->
			<if test="goodsSearchVO.min_price != null and goodsSearchVO.min_price != 0">
				<![CDATA[
				and p.sale_price >= #{goodsSearchVO.min_price}
				]]>
			</if>
			<!-- 최대가격 -->
			<if test="goodsSearchVO.max_price != null and goodsSearchVO.max_price != 0">
				<![CDATA[
				and p.sale_price <= #{goodsSearchVO.max_price}
				]]>
			</if>
		</trim>
  	</sql>
  	
  	<!-- 대분류/중분류/소분류 가져오기 -->
  	<select id="getCategory" resultType="org.zerock.category.vo.CategoryVO">
  		select
  			cate_code1, cate_code2, cate_code3, cate_name
  		from
  			category
  		where
  			<!-- 대분류 조건 -->
  			<if test="cate_code1 == 0">
  				cate_code2 = 0 and cate_code3 = 0
  			</if>
  			<!-- 중분류 조건 -->
  			<if test="cate_code1 > 0 and cate_code2 == 0">
  				cate_code1 = #{cate_code1} and cate_code2 = 0
  			</if>
  			<!-- 소분류 조건 -->
  			<if test="cate_code1 > 0 and cate_code2 > 0">
  				cate_code1 = #{cate_code1} and cate_code2 = #{cate_code2} and cate_code3 != 0
  			</if>
  	</select>
  	
  	<!-- 상품 상세 보기 -->
  	<select id="view" resultType="org.zerock.goods.vo.GoodsVO">
  		select
			g.goods_no, g.goods_name, g.cate_code1, 
			g.cate_code2, g.cate_code3, g.image_name, c.cate_name,
			g.content, g.company, g.product_date,
			p.price, p.discount,
			p.sale_price, p.delivery_charge, 
			p.sale_start_date, p.sale_end_date,
			p.goods_price_no
		from goods g, goods_price p, category c
  		where
  			(g.goods_no = #{goods_no})
  			<![CDATA[
		  	and ( 
		  	sale_start_date <= sysDate and
		  	trunc(sysDate) <= sale_end_date
		  	)
		  	]]>
  			and (g.goods_no = p.goods_no)
  			and (g.cate_code1 = c.cate_code1 and g.cate_code2 = c.cate_code2 and g.cate_code3 = c.cate_code3)
  	</select>
  	
  	<!-- 1. 상품 등록 -->
  	<insert id="write">
  		<selectKey keyProperty="goods_no" resultType="Long" order="BEFORE">
  			select goods_seq.nextval from dual
  		</selectKey>
  		insert into goods
  			(goods_no, goods_name,
  			cate_code1, cate_code2, cate_code3, image_name,
  			content, company, product_date)
  		values
	  		(#{goods_no}, #{goods_name}, #{cate_code1},
	  		#{cate_code2}, #{cate_code3}, #{image_name}, #{content},
	  		#{company}, #{product_date,jdbcType=DATE})
  	</insert>

	<!-- 가격 정보 등록 -->
	<insert id="writePrice">
		insert into goods_price
			(goods_price_no, price, discount,
			 sale_price, delivery_charge
			<if test="sale_start_date != null">
			, sale_start_date
			</if>
			<if test="sale_end_date != null">
			, sale_end_date
			</if>
			, goods_no)
		values
			(goods_price_seq.nextval, #{price},
			#{discount,jdbcType=INTEGER},
			#{sale_price},
			#{delivery_charge,jdbcType=INTEGER}
			<if test="sale_start_date != null">
				, #{sale_start_date,jdbcType=DATE}
			</if>
			<if test="sale_end_date != null">
				, #{sale_end_date,jdbcType=DATE}
			</if>	
			, #{goods_no})
	</insert>

	<!-- 상품 수정 -->
	<update id="update">
		update goods set
			cate_code1 = #{cate_code1}, cate_code2 = #{cate_code2}, cate_code3 = #{cate_code3},
			goods_name = #{goods_name}, company = #{company},
			content = #{content}, product_date = #{product_date}
		where 
			goods_no = #{goods_no}
	</update>

	<!-- 상품 가격 수정 -->
	<update id="updatePrice">
		update goods_price set
			price = #{price}, discount = #{discount},
			sale_price = #{sale_price},
			delivery_charge = #{delivery_charge},
			sale_start_date = #{sale_start_date},
			sale_end_date = #{sale_end_date}
		where
			goods_no = #{goods_no} and goods_price_no = #{goods_price_no}
	</update>
	
	<!-- 상품 추가 이미지 삭제 -->
	<delete id="deleteImage">
		delete from goods_image
		where image_name = #{image_name}
	</delete>
</mapper>
  
  
  
  