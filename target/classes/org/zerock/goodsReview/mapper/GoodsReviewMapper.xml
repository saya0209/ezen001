<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="org.zerock.goodsReview.mapper.GoodsReviewMapper">
  	<!-- 일반 게시판 리뷰 리스트 페이지 처리를 위한 전체 데이터 개수(글번호)를 가져오는 쿼리 -->
  	<select id="getTotalRow" resultType="Long">
  		select count(*)
  		from goods_review
  		where goods_no = #{goods_no}
  	</select>
  	<!-- 일반 게시판 리뷰 리스트 쿼리 -->
  	<select id="list" resultType="org.zerock.goodsReview.vo.GoodsReviewVO">
  		select rno, goods_no, content, id, nicname, writeDate, rating
  		from
  		(
	  		select rownum rnum, rno, goods_no, content, id, nicname, writeDate, rating
	  		from
	  		(
			  	select b.rno, b.goods_no, b.content, b.id, m.nicname, b.writeDate, b.rating
			  	from goods_review b, member m
			  	where
			  		(goods_no = #{goods_no}) <!-- 일반조건 -->
			  		and
			  		(b.id = m.id) <!-- 조인조건 -->
			  	order by rno desc
		  	)
	  	)
	  	where rnum between #{pageObject.startRow} and #{pageObject.endRow}
  	</select>
  	

	<!-- 일반 게시판 리뷰쓰기 쿼리 -->
	<insert id="write">
	    <selectKey keyProperty="rno" resultType="Long" order="BEFORE">
	        select goods_review_seq.nextval from dual
	    </selectKey>
	    insert into goods_review(rno, goods_no, content, id, nicname, writeDate, rating)
	    values(#{rno}, #{goods_no}, #{content}, #{id}, #{nicname}, sysdate, #{rating})
	</insert>

	
	<!-- 일반 게시판 리뷰수정 쿼리 -->
	<update id="update">
	<!-- ![CDATA[]] 를 사용하면 특수문자를 string으로 인식하게 만들어준다. -->
	<![CDATA[
		update goods_review
		set content = #{content}
		where rno = #{rno} and id = #{id}
	]]>
	</update>
	
	<!-- 일반 게시판 리뷰삭제 쿼리 -->
	<delete id="delete">
		delete from goods_review
		where rno = #{rno} and id = #{id}
	</delete>
	
	<!-- 특정 회원이 특정 상품에 대해 이미 리뷰를 작성했는지 확인 -->
    <select id="checkReviewExists" parameterType="org.zerock.goodsReview.vo.GoodsReviewVO" resultType="int">
	    SELECT COUNT(*) 
	    FROM goods_review 
	    WHERE id = #{id} AND goods_no = #{goods_no}
	</select>

  </mapper>
  
  
  
  
  
  